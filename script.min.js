document.addEventListener('DOMContentLoaded',()=>{let allRhymes=[],allStories=[],allExclusiveRhymes=[],authors={"Vikas Rana":{bio:"Vikas Rana is a passionate storyteller and creator based in the beautiful hills of Dharamshala. He loves crafting imaginative tales and catchy rhymes that spark curiosity and joy in young readers. He believes in the power of simple words to create magical worlds for children. When he's not writing, he enjoys exploring nature and sipping on a warm cup of chai.",image:"https://placehold.co/150x150/E34037/FFFFFF?text=VR",x_profile:"https://x.com/Vikasrana03"}},currentRhymeList=[],favorites=JSON.parse(localStorage.getItem('favoriteRhymes'))||[],favoriteStories=JSON.parse(localStorage.getItem('favoriteStories'))||[],playlist=JSON.parse(localStorage.getItem('playlist'))||[],currentRhyme=null,currentStory=null,isPlaylistMode=!1,currentPlaylistIndex=-1,originalTitle=document.title,utterance=null,isReading=!1,englishVoice=null,hindiVoice=null;const loadingIndicator=document.getElementById('loading-indicator'),homeButton=document.getElementById('home-button'),rhymeGalleryView=document.getElementById('rhyme-gallery'),storyGalleryView=document.getElementById('story-gallery'),rhymeDetailView=document.getElementById('rhyme-detail'),storyDetailView=document.getElementById('story-detail'),legalView=document.getElementById('legal-view'),comingSoonView=document.getElementById('coming-soon-view'),authorDetailView=document.getElementById('author-detail'),rhymeOfTheDaySection=document.getElementById('rhyme-of-the-day'),rhymeGrid=document.getElementById('rhyme-grid'),storyGrid=document.getElementById('story-grid'),comingSoonRhymesList=document.getElementById('coming-soon-rhymes-list'),comingSoonStoriesList=document.getElementById('coming-soon-stories-list'),authorStoriesGrid=document.getElementById('author-stories-grid'),controlsSection=document.getElementById('controls-section'),rhymeControls=document.getElementById('rhyme-controls'),storyControls=document.getElementById('story-controls'),searchBar=document.getElementById('search-bar'),storySearchBar=document.getElementById('story-search-bar'),categoryFilters=document.getElementById('category-filters'),storyCategoryFilters=document.getElementById('story-category-filters'),surpriseButton=document.getElementById('surprise-button'),storySurpriseButton=document.getElementById('story-surprise-button'),backToTopBtn=document.getElementById('back-to-top-btn'),backButton=document.getElementById('back-button'),favoriteBtn=document.getElementById('favorite-btn'),previousDetailRhymeBtn=document.getElementById('previous-detail-rhyme-btn'),nextDetailRhymeBtn=document.getElementById('next-detail-rhyme-btn'),readAloudRhymeBtn=document.getElementById('read-aloud-btn-rhyme'),shareRhymeBtn=document.getElementById('share-rhyme-btn'),printRhymeBtn=document.getElementById('print-rhyme-btn'),storyBackButton=document.getElementById('story-back-button'),storyFavoriteBtn=document.getElementById('story-favorite-btn'),addToStoryPlaylistBtn=document.getElementById('add-to-story-playlist-btn'),previousDetailStoryBtn=document.getElementById('previous-detail-story-btn'),nextDetailStoryBtn=document.getElementById('next-detail-story-btn'),readAloudStoryBtn=document.getElementById('read-aloud-btn-story'),shareStoryBtn=document.getElementById('share-story-btn'),printStoryBtn=document.getElementById('print-story-btn'),storyAuthorContainer=document.getElementById('story-author-container'),legalLink=document.getElementById('legal-link'),legalBackButton=document.getElementById('legal-back-button'),comingSoonLink=document.getElementById('coming-soon-link'),comingSoonBackButton=document.getElementById('coming-soon-back-button'),authorBackButton=document.getElementById('author-back-button'),playlistToggleBtn=document.getElementById('playlist-toggle-btn'),playlistView=document.getElementById('playlist-view'),closePlaylistBtn=document.getElementById('close-playlist-btn'),playlistItemsContainer=document.getElementById('playlist-items'),clearPlaylistBtn=document.getElementById('clear-playlist-btn'),playlistCountEl=document.getElementById('playlist-count'),addToPlaylistBtn=document.getElementById('add-to-playlist-btn'),playlistNavButtons=document.getElementById('playlist-nav-buttons'),prevRhymeBtn=document.getElementById('prev-rhyme-btn'),nextRhymeBtn=document.getElementById('next-rhyme-btn'),playlistPositionEl=document.getElementById('playlist-position'),storyPlaylistNavButtons=document.getElementById('story-playlist-nav-buttons'),prevStoryBtn=document.getElementById('prev-story-btn'),nextStoryBtn=document.getElementById('next-story-btn'),storyPlaylistPositionEl=document.getElementById('story-playlist-position'),toastNotification=document.getElementById('toast-notification'),footerShareLink=document.getElementById('footer-share-link'),originalDefaultTitle=document.title,originalDefaultDescription=document.querySelector('meta[name="description"]').getAttribute('content'),originalDefaultCanonical=document.querySelector('link[rel="canonical"]').getAttribute('href');function updateMetaTags(e,t,n){document.title=e;let o=document.querySelector('meta[name="description"]');o?o.setAttribute('content',t):((o=document.createElement("meta")).setAttribute("name","description"),o.setAttribute("content",t),document.head.appendChild(o)),document.querySelector('meta[property="og:title"]').setAttribute("content",e),document.querySelector('meta[property="og:description"]').setAttribute("content",t),document.querySelector('meta[property="og:url"]').setAttribute("content",n),document.querySelector('meta[property="twitter:title"]').setAttribute("content",e),document.querySelector('meta[property="twitter:description"]').setAttribute("content",t),document.querySelector('meta[property="twitter:url"]').setAttribute("content",n)}function resetMetaTags(){updateMetaTags(originalDefaultTitle,originalDefaultDescription,originalDefaultCanonical),updateJsonLd(null)}function init(){loadAllData(),addEventListeners(),updatePlaylistCount()}async function fetchWithRetry(e,t=3,n=500){for(let o=0;o<t;o++)try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(r){if(console.warn(`Attempt ${o+1} failed for ${e}. Retrying in ${n}ms...`,r),o<t-1)await new Promise(e=>setTimeout(e,n)),n*=2;else throw r}}async function loadAllData(){try{const[e,t,n]=await Promise.all([fetchWithRetry("public_rhymes.json"),fetchWithRetry("exclusive_rhymes.json"),fetchWithRetry("short_stories.json")]);allExclusiveRhymes=t,allStories=n;const o=new Date,r=allExclusiveRhymes.filter(e=>!e.releaseDate||new Date(e.releaseDate)<=o);allRhymes=[...e,...r].sort((e,t)=>e.id-t.id),handleUrlParams(),loadingIndicator.style.display="none"}catch(e){console.error("Could not fetch data after multiple retries:",e),loadingIndicator.innerHTML='<p class="text-red-500 text-center font-body">Sorry, could not load content. Please check your internet connection and try refreshing the page.</p>'}}function handleUrlParams(){const e=new URLSearchParams(window.location.search),t=e.get("rhyme"),n=e.get("story"),o=e.get("author"),r=e.get("category"),a=e.get("page");t?showRhymeDetail(parseInt(t)):n?showStoryDetail(parseInt(n)):o?showAuthorDetail(o):"legal"===a?showLegalView():"coming-soon"===a?showComingSoonView():r?(updateActiveCategoryButton(r),showMainView(r)):(resetMetaTags(),showMainView("Rhymes"))}function updateUrl(e){const t=new URL(window.location);t.search="";let n=!1;for(const o in e)e[o]&&(t.searchParams.set(o,e[o]),"rhyme"!==o&&"story"!==o&&"page"!==o&&"author"!==o||(n=!0));window.history.pushState({},"",t);const o=n?t.href:"https://kids.toolblaster.com/";updateCanonicalUrl(o)}function updateCanonicalUrl(e){let t=document.querySelector("link[rel='canonical']");t&&t.setAttribute("href",e)}function updateJsonLd(e,t){const n=document.getElementById("item-schema");if(n&&n.remove(),!e)return;const o={"@context":"https://schema.org",mainEntityOfPage:{"@type":"WebPage","@id":window.location.href},headline:e.title,publisher:{"@type":"Organization",name:"kids.toolblaster.com"}};"rhyme"===t?(o["@type"]="CreativeWork",o.text=e.lyrics,o.author={"@type":"Person",name:"Traditional"},e.isExclusive?(o.copyrightHolder={"@type":"Organization",name:"kids.toolblaster.com"},o.copyrightYear=(new Date).getFullYear()):(o.license="https://creativecommons.org/publicdomain/mark/1.0/",o.citation="Based on a traditional public domain nursery rhyme.")):"story"===t?(o["@type"]="ShortStory",o.text=e.content.join("\n\n"),o.author={"@type":"Person",name:e.author},o.copyrightHolder={"@type":"Organization",name:"kids.toolblaster.com"},o.copyrightYear=(new Date).getFullYear()):"author"===t&&(o["@type"]="ProfilePage",o.about={"@type":"Person",name:e.name,description:e.bio});const r=document.createElement("script");r.type="application/ld+json",r.id="item-schema",r.text=JSON.stringify(o,null,2),document.head.appendChild(r)}function hideAllViews(){rhymeGalleryView.classList.add("hidden"),storyGalleryView.classList.add("hidden"),rhymeDetailView.classList.add("hidden"),storyDetailView.classList.add("hidden"),legalView.classList.add("hidden"),comingSoonView.classList.add("hidden"),authorDetailView.classList.add("hidden"),rhymeOfTheDaySection.classList.add("hidden"),controlsSection.classList.add("hidden"),rhymeControls.classList.add("hidden"),storyControls.classList.add("hidden"),stopReading()}function showMainView(e){hideAllViews(),controlsSection.classList.remove("hidden"),resetMetaTags();if("Stories"===e||"StoryFavorites"===e){storyGalleryView.classList.remove("hidden"),storyControls.classList.remove("hidden");let t;"StoryFavorites"===e?t=allStories.filter(e=>isFavoriteStory(e.id)):t=allStories.filter(e=>!e.releaseDate||new Date(e.releaseDate)<=new Date),displayStoryGallery(t)}else{rhymeGalleryView.classList.remove("hidden"),rhymeControls.classList.remove("hidden"),rhymeOfTheDaySection.classList.remove("hidden");let t;"Favorites"===e?t=allRhymes.filter(e=>isFavorite(e.id)):"New"===e?t=allRhymes.filter(e=>e.isExclusive):"Lullaby"===e?t=allRhymes.filter(e=>e.tags&&e.tags.includes("lullaby")):["Animal","Learning","Classic","Indian"].includes(e)?t=allRhymes.filter(t=>t.category===e):t=allRhymes,displayRhymeGallery(t),displayRhymeOfTheDay()}}function showLegalView(){hideAllViews(),legalView.classList.remove("hidden");updateMetaTags("Contact & Legal - Kids Rhymes & Stories","Contact information and legal disclaimers for kids.toolblaster.com.","https://kids.toolblaster.com/?page=legal"),updateUrl({page:"legal"}),window.scrollTo(0,0)}function showComingSoonView(){hideAllViews(),comingSoonView.classList.remove("hidden");updateMetaTags("Coming Soon! - Kids Rhymes & Stories","See what new rhymes and stories are coming soon to kids.toolblaster.com.","https://kids.toolblaster.com/?page=coming-soon"),updateUrl({page:"coming-soon"}),window.scrollTo(0,0);const e=new Date,t=allExclusiveRhymes.filter(t=>t.releaseDate&&new Date(t.releaseDate)>e).sort((e,t)=>new Date(e.releaseDate)-new Date(t.releaseDate)),n=allStories.filter(t=>t.releaseDate&&new Date(t.releaseDate)>e).sort((e,t)=>new Date(e.releaseDate)-new Date(t.releaseDate));comingSoonRhymesList.innerHTML="",comingSoonStoriesList.innerHTML="";const o=(e,t)=>{const n=new Date(e.releaseDate),o={year:"numeric",month:"long",day:"numeric"},r=n.toLocaleDateString("en-US",o),a=document.createElement("div"),i="Story"===t?"border-blue-500":"border-green-500";return a.className=`flex items-center p-4 bg-gray-50 rounded-lg shadow-sm border-l-4 ${i}`,a.innerHTML=`\n                <div class="text-4xl mr-4">${e.icon||("Rhyme"===t?"üéµ":"üìö")}</div>\n                <div class="flex-grow">\n                    <h3 class="text-base font-bold text-brand-dark">${e.title}</h3>\n                    <p class="text-sm text-gray-600 font-body">Coming on: <span class="font-semibold">${r}</span></p>\n                </div>\n            `,a};t.length>0?t.forEach(e=>{comingSoonRhymesList.appendChild(o(e,"Rhyme"))}):comingSoonRhymesList.innerHTML='<p class="text-center text-gray-600 font-body p-4 bg-gray-50 rounded-lg">No new rhymes scheduled right now.</p>',n.length>0?n.forEach(e=>{comingSoonStoriesList.appendChild(o(e,"Story"))}):comingSoonStoriesList.innerHTML='<p class="text-center text-gray-600 font-body p-4 bg-gray-50 rounded-lg">No new stories scheduled right now.</p>'}function goHome(){searchBar.value="",storySearchBar.value="",isPlaylistMode=!1,currentPlaylistIndex=-1,updateActiveCategoryButton("Rhymes"),resetMetaTags(),showMainView("Rhymes"),updateUrl({category:"Rhymes"})}function goBackToGallery(){isPlaylistMode=!1,currentPlaylistIndex=-1;const e=document.querySelector(".main-nav-btn.active").dataset.category||"Rhymes";resetMetaTags(),showMainView(e),updateUrl({category:e})}function goBackToStoryGalleryFromAuthor(){resetMetaTags(),showMainView("Stories"),updateUrl({category:"Stories"})}function displayRhymeGallery(e){if(currentRhymeList=e,rhymeGrid.innerHTML="",0===e.length){const e=document.querySelector("#category-filters .category-btn.active");let t='<p class="text-gray-500 col-span-full text-center font-body">No rhymes found for your search.</p>';return e&&"Favorites"===e.dataset.category&&(t='\n                    <div class="col-span-full text-center p-6 bg-gray-50 rounded-lg">\n                        <div class="text-4xl mb-2">‚ù§Ô∏è</div>\n                        <h3 class="text-lg font-bold text-brand-dark">Your Favorites is Empty</h3>\n                        <p class="text-gray-500 mt-1 font-body">Click the white heart on any rhyme to add it here!</p>\n                    </div>\n                '),void(rhymeGrid.innerHTML=t)}e.forEach(e=>{const t=document.createElement("div");t.className="rhyme-card bg-white rounded-xl shadow-lg cursor-pointer transform hover:scale-105 transition-all duration-300 flex flex-col p-4 text-center relative",t.dataset.rhymeId=e.id;const n=e.isExclusive?'<div class="absolute top-1 left-1 bg-yellow-400 text-black text-xs font-bold px-2 py-0.5 rounded-full">NEW</div>':"",o=isFavorite(e.id)?"‚ù§Ô∏è":"";t.innerHTML=`\n                ${n}\n                <div class="flex-grow flex flex-col items-center justify-center">\n                    <div class="text-5xl mb-2">${e.icon||"üéµ"}</div>\n                    <h3 class="text-sm font-bold text-brand-dark">${e.title}</h3>\n                </div>\n                <div class="absolute top-2 right-2 text-xl favorite-indicator">${o}</div>\n            `,t.addEventListener("click",()=>showRhymeDetail(e.id)),rhymeGrid.appendChild(t)})}function showRhymeDetail(e,t=!1,n=-1){if(currentRhyme=allRhymes.find(t=>t.id===e),!currentRhyme)return;currentStory=null,hideAllViews(),rhymeDetailView.classList.remove("hidden");const o=`https://kids.toolblaster.com/?rhyme=${e}`,r=`Read the ${currentRhyme.title} nursery rhyme in English ${currentRhyme.lyrics_hi?"and Hindi":""}. ${currentRhyme.funFact||""}`.substring(0,160);updateMetaTags(`${currentRhyme.title} - Kids Rhymes`,r,o),updateUrl({rhyme:e}),updateJsonLd(currentRhyme,"rhyme"),stopReading(),updateReadAloudButton(readAloudRhymeBtn),isPlaylistMode=t,currentPlaylistIndex=t?n:-1,document.getElementById("rhyme-title-en").textContent=currentRhyme.title,document.getElementById("rhyme-lyrics-en").textContent=currentRhyme.lyrics;const a=document.getElementById("rhyme-title-hi"),i=document.getElementById("hindi-column");currentRhyme.title_hi&&currentRhyme.lyrics_hi?(a.textContent=currentRhyme.title_hi,document.getElementById("rhyme-lyrics-hi").textContent=currentRhyme.lyrics_hi,i.classList.remove("hidden")):(a.textContent="",document.getElementById("rhyme-lyrics-hi").textContent="",i.classList.add("hidden"));const s=document.getElementById("learning-focus-badge-container");currentRhyme.learningFocus?(document.getElementById("learning-focus-badge").textContent=`Focus: ${currentRhyme.learningFocus}`,s.classList.remove("hidden")):s.classList.add("hidden"),favoriteBtn.innerHTML=isFavorite(e)?"‚ù§Ô∏è":"ü§ç",favoriteBtn.setAttribute("data-id",e);const c=document.getElementById("fun-fact-container"),l=document.getElementById("fun-fact-details");currentRhyme.funFact?(document.getElementById("fun-fact-text").textContent=currentRhyme.funFact,c.classList.remove("hidden"),l.removeAttribute("open")):c.classList.add("hidden");const d=document.getElementById("copyright-notice-container"),u=document.getElementById("copyright-text");d.classList.remove("hidden"),currentRhyme.isExclusive?u.textContent=`Copyright ¬© ${(new Date).getFullYear()} kids.toolblaster.com. This is an Original and Exclusive Rhyme üéµ`:u.textContent="This content is in the public domain.";const m=currentRhymeList.find(t=>t.id===e)?currentRhymeList:allRhymes,h=m.findIndex(t=>t.id===e);previousDetailRhymeBtn.disabled=h<=0,nextDetailRhymeBtn.disabled=h>=m.length-1,updateAddToPlaylistButton(),updatePlaylistNav(),window.scrollTo(0,0)}function displayStoryGallery(e){if(storyGrid.innerHTML="",0===e.length){const e=document.querySelector("#story-category-filters .category-btn.active");let t='<p class="text-gray-500 col-span-full text-center font-body">No stories found for your search.</p>';return e&&"StoryFavorites"===e.dataset.category&&(t='\n                    <div class="col-span-full text-center p-6 bg-gray-50 rounded-lg">\n                        <div class="text-4xl mb-2">‚ù§Ô∏è</div>\n                        <h3 class="text-lg font-bold text-brand-dark">Your Favorite Stories is Empty</h3>\n                        <p class="text-gray-500 mt-1 font-body">Click the white heart on any story to add it here!</p>\n                    </div>\n                '),void(storyGrid.innerHTML=t)}e.forEach(e=>{const t=document.createElement("div");t.className="story-card bg-white rounded-xl shadow-lg cursor-pointer transform hover:scale-105 transition-all duration-300 flex flex-col p-4 text-center relative",t.dataset.storyId=e.id;const n='<div class="absolute top-1 left-1 bg-yellow-400 text-black text-xs font-bold px-2 py-0.5 rounded-full">NEW</div>',o=isFavoriteStory(e.id)?"‚ù§Ô∏è":"";t.innerHTML=`\n                ${n}\n                <div class="flex-grow flex flex-col items-center justify-center">\n                    <div class="text-5xl mb-2">${e.icon||"üìö"}</div>\n                    <h3 class="text-sm font-bold text-brand-dark">${e.title}</h3>\n                    <p class="text-sm text-gray-500 mt-1 font-body">by ${e.author}</p>\n                </div>\n                <div class="absolute top-2 right-2 text-xl favorite-indicator">${o}</div>\n            `,t.addEventListener("click",()=>showStoryDetail(e.id)),storyGrid.appendChild(t)})}function showStoryDetail(e,t=!1,n=-1){if(currentStory=allStories.find(t=>t.id===e),!currentStory)return;currentRhyme=null,hideAllViews(),storyDetailView.classList.remove("hidden");const o=`https://kids.toolblaster.com/?story=${e}`,r=currentStory.summary?currentStory.summary.substring(0,160):`Read the short story "${currentStory.title}" by ${currentStory.author}.`;updateMetaTags(`${currentStory.title} - Kids Stories`,r,o),updateUrl({story:e}),updateJsonLd(currentStory,"story"),stopReading(),updateReadAloudButton(readAloudStoryBtn),isPlaylistMode=t,currentPlaylistIndex=t?n:-1,document.getElementById("story-title").textContent=currentStory.title;const a=document.getElementById("story-author-link");a.textContent=currentStory.author,a.dataset.author=currentStory.author,document.getElementById("story-read-time").textContent=currentStory.readTime;const i=document.getElementById("story-content");i.innerHTML="",currentStory.content.forEach(e=>{const t=document.createElement("p");t.textContent=e.trim(),i.appendChild(t)});const s=document.getElementById("story-title-hi"),c=document.getElementById("story-content-hi-container"),l=document.getElementById("story-content-hi");currentStory.title_hi&&currentStory.content_hi?(s.textContent=currentStory.title_hi,l.innerHTML="",currentStory.content_hi.forEach(e=>{const t=document.createElement("p");t.textContent=e.trim(),l.appendChild(t)}),c.classList.remove("hidden")):(s.textContent="",c.classList.add("hidden"));const d=document.getElementById("story-moral-container"),u=document.getElementById("story-moral-hi").parentElement;currentStory.moral?(document.getElementById("story-moral").textContent=currentStory.moral,currentStory.moral_hi?(document.getElementById("story-moral-hi").textContent=currentStory.moral_hi,u.classList.remove("hidden")):u.classList.add("hidden"),d.classList.remove("hidden")):d.classList.add("hidden");const m=document.getElementById("story-copyright-notice-container"),h=document.getElementById("story-copyright-text");h.textContent=`Copyright ¬© ${(new Date).getFullYear()} kids.toolblaster.com. This is an Original and Exclusive Story üìö`,m.classList.remove("hidden");const y=allStories.filter(e=>!e.releaseDate||new Date(e.releaseDate)<=new Date),g=y.findIndex(t=>t.id===currentStory.id);previousDetailStoryBtn.disabled=g<=0,nextDetailStoryBtn.disabled=g>=y.length-1,storyFavoriteBtn.innerHTML=isFavoriteStory(e)?"‚ù§Ô∏è":"ü§ç",updateAddToStoryPlaylistButton(),updatePlaylistNav(),window.scrollTo(0,0)}function showAuthorDetail(e){const t=authors[e];if(!t)return void goBackToStoryGalleryFromAuthor();hideAllViews(),authorDetailView.classList.remove("hidden");const n=`https://kids.toolblaster.com/?author=${encodeURIComponent(e)}`,o=`Read original stories by ${e}. ${t.bio}`.substring(0,160);updateMetaTags(`${e} - Author Profile`,o,n),updateUrl({author:e}),updateJsonLd({name:e,...t},"author"),document.getElementById("author-name").textContent=e,document.getElementById("author-bio").textContent=t.bio,document.getElementById("author-image").src=t.image,document.getElementById("author-image").alt=`A photo of ${e}`;const r=document.getElementById("author-social-link");t.x_profile?(r.href=t.x_profile,r.classList.remove("hidden")):r.classList.add("hidden"),window.scrollTo(0,0)}function displayRhymeOfTheDay(){const e=Math.floor((new Date-new Date((new Date).getFullYear(),0,0))/864e5),t=allRhymes[e%allRhymes.length];t&&(document.getElementById("rotd-icon").textContent=t.icon||"üéµ",document.getElementById("rotd-title").textContent=t.title,document.getElementById("rotd-card").addEventListener("click",()=>showRhymeDetail(t.id)))}function addEventListeners(){homeButton.addEventListener("click",goHome),backButton.addEventListener("click",goBackToGallery),storyBackButton.addEventListener("click",goBackToGallery),legalBackButton.addEventListener("click",goHome),authorBackButton.addEventListener("click",goBackToStoryGalleryFromAuthor),legalLink.addEventListener("click",e=>{e.preventDefault(),showLegalView()}),comingSoonLink.addEventListener("click",e=>{e.preventDefault(),showComingSoonView()}),comingSoonBackButton.addEventListener("click",goHome),searchBar.addEventListener("input",handleSearchInput),storySearchBar.addEventListener("input",handleStorySearchInput),document.getElementById("main-navigation").addEventListener("click",handleCategoryClick),categoryFilters.addEventListener("click",handleCategoryClick),storyCategoryFilters.addEventListener("click",handleCategoryClick),surpriseButton.addEventListener("click",showRandomRhyme),storySurpriseButton.addEventListener("click",showRandomStory),previousDetailRhymeBtn.addEventListener("click",showPreviousRhyme),nextDetailRhymeBtn.addEventListener("click",showNextRhyme),previousDetailStoryBtn.addEventListener("click",showPreviousStory),nextDetailStoryBtn.addEventListener("click",showNextStory),favoriteBtn.addEventListener("click",handleFavoriteClick),storyFavoriteBtn.addEventListener("click",handleFavoriteStoryClick),addToStoryPlaylistBtn.addEventListener("click",handleAddToStoryPlaylist),storyAuthorContainer.addEventListener("click",e=>{if("story-author-link"===e.target.id){e.preventDefault();const t=e.target.dataset.author;t&&showAuthorDetail(t)}}),readAloudRhymeBtn.addEventListener("click",()=>toggleReadAloud("rhyme")),readAloudStoryBtn.addEventListener("click",()=>toggleReadAloud("story")),playlistToggleBtn.addEventListener("click",togglePlaylistView),closePlaylistBtn.addEventListener("click",togglePlaylistView),addToPlaylistBtn.addEventListener("click",handleAddToPlaylist),clearPlaylistBtn.addEventListener("click",clearPlaylist),playlistItemsContainer.addEventListener("click",handlePlaylistItemClick),prevRhymeBtn.addEventListener("click",playPreviousPlaylistItem),nextRhymeBtn.addEventListener("click",playNextPlaylistItem),prevStoryBtn.addEventListener("click",playPreviousPlaylistItem),nextStoryBtn.addEventListener("click",playNextPlaylistItem),window.addEventListener("scroll",handleScroll),backToTopBtn.addEventListener("click",scrollToTop),shareRhymeBtn.addEventListener("click",()=>shareContent("rhyme")),printRhymeBtn.addEventListener("click",()=>printContent("rhyme")),shareStoryBtn.addEventListener("click",()=>shareContent("story")),printStoryBtn.addEventListener("click",()=>printContent("story")),footerShareLink.addEventListener("click",e=>{e.preventDefault(),shareContent("website")})}function handleSearchInput(){let e=allRhymes.filter(e=>e.title.toLowerCase().includes(searchBar.value.toLowerCase())||e.lyrics.toLowerCase().includes(searchBar.value.toLowerCase()));displayRhymeGallery(e)}function handleStorySearchInput(){let e=allStories.filter(e=>(!e.releaseDate||new Date(e.releaseDate)<=new Date)&&(e.title.toLowerCase().includes(storySearchBar.value.toLowerCase())||e.content.join(" ").toLowerCase().includes(storySearchBar.value.toLowerCase())));displayStoryGallery(e)}function handleCategoryClick(e){const t=e.target.closest(".category-btn");if(t){searchBar.value="",storySearchBar.value="";const e=t.dataset.category;updateActiveCategoryButton(e),showMainView(e),updateUrl({category:e})}}function updateActiveCategoryButton(e){document.querySelectorAll("#category-filters .category-btn, #story-category-filters .category-btn").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`.category-btn[data-category="${e}"]`);t&&!t.closest("#main-navigation")&&t.classList.add("active");const n=["Stories","StoryFavorites"].includes(e);document.querySelector('.main-nav-btn[data-category="Stories"]').classList.toggle("active",n),document.querySelector('.main-nav-btn[data-category="Rhymes"]').classList.toggle("active",!n)}function showRandomRhyme(){const e=Math.floor(Math.random()*allRhymes.length);showRhymeDetail(allRhymes[e].id)}function showRandomStory(){const e=allStories.filter(e=>!e.releaseDate||new Date(e.releaseDate)<=new Date),t=Math.floor(Math.random()*e.length);showStoryDetail(e[t].id)}function showPreviousRhyme(){if(!currentRhyme)return;const e=currentRhymeList.find(e=>e.id===currentRhyme.id)?currentRhymeList:allRhymes,t=e.findIndex(e=>e.id===currentRhyme.id);t>0&&showRhymeDetail(e[t-1].id)}function showNextRhyme(){if(!currentRhyme)return;const e=currentRhymeList.find(e=>e.id===currentRhyme.id)?currentRhymeList:allRhymes,t=e.findIndex(e=>e.id===currentRhyme.id);t<e.length-1&&showRhymeDetail(e[t+1].id)}function showPreviousStory(){if(!currentStory)return;const e=allStories.filter(e=>!e.releaseDate||new Date(e.releaseDate)<=new Date),t=e.findIndex(e=>e.id===currentStory.id);t>0&&showStoryDetail(e[t-1].id)}function showNextStory(){if(!currentStory)return;const e=allStories.filter(e=>!e.releaseDate||new Date(e.releaseDate)<=new Date),t=e.findIndex(e=>e.id===currentStory.id);t<e.length-1&&showStoryDetail(e[t+1].id)}function showToast(e){toastNotification.textContent=e,toastNotification.classList.add("show"),setTimeout(()=>{toastNotification.classList.remove("show")},2500)}function shareContent(e){let t=window.location.href,n=document.title,o="Check out this fun website for kids!";"rhyme"===e&&currentRhyme?(n=`${currentRhyme.title} - Kids Rhymes & Stories`,o=`Check out the rhyme "${currentRhyme.title}"!`):"story"===e&&currentStory?(n=`${currentStory.title} - Kids Rhymes & Stories`,o=`Check out the story "${currentStory.title}"!`):t="https://kids.toolblaster.com/",navigator.share?navigator.share({title:n,text:o,url:t}).catch(console.error):navigator.clipboard.writeText(t).then(()=>{showToast("Link copied to clipboard!")},()=>{showToast("Could not copy link.")})}function printContent(e){document.body.classList.add("rhyme"===e?"printing-rhyme":"printing-story"),window.print(),document.body.classList.remove("printing-rhyme","printing-story")}function getVoiceForLanguage(e){const t=window.speechSynthesis.getVoices();let n=null,o=null;const r={"en-US":["Google US English Female","Microsoft Zira - English (United States)","Google UK English Female","Samantha"],"hi-IN":["Google ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä"]};return r[e]&&(n=t.find(t=>r[e].includes(t.name))),n||(o=t.find(t=>t.lang.startsWith(e)&&(t.name.includes("Female")||t.name.includes("Google")))),!n&&!o&&(o=t.find(t=>t.lang.startsWith(e))),n||o||null}window.speechSynthesis.onvoiceschanged=()=>{englishVoice=getVoiceForLanguage("en-US"),hindiVoice=getVoiceForLanguage("hi-IN")};function toggleReadAloud(e){if(!("speechSynthesis"in window))return void showToast("Sorry, your browser doesn't support text-to-speech.");if(isReading)return void stopReading();let t,n,o;if("rhyme"===e&&currentRhyme)t={en:currentRhyme.lyrics,hi:currentRhyme.lyrics_hi},n=readAloudRhymeBtn,o=!!currentRhyme.lyrics_hi;else{if(!("story"===e&&currentStory))return;t={en:currentStory.content.join(" "),hi:currentStory.content_hi?currentStory.content_hi.join(" "):""},n=readAloudStoryBtn,o=!!currentStory.content_hi}const r=new SpeechSynthesisUtterance(t.en);if(r.lang="en-US",englishVoice&&(r.voice=englishVoice),r.onstart=()=>{isReading=!0,updateReadAloudButton(n)},o&&t.hi){const e=new SpeechSynthesisUtterance(t.hi);e.lang="hi-IN",hindiVoice&&(e.voice=hindiVoice),r.onend=()=>{isReading&&window.speechSynthesis.speak(e)},e.onend=()=>stopReading(n)}else r.onend=()=>stopReading(n);window.speechSynthesis.speak(r)}function stopReading(e){isReading=!1,window.speechSynthesis.cancel(),e?updateReadAloudButton(e):(updateReadAloudButton(readAloudRhymeBtn),updateReadAloudButton(readAloudStoryBtn))}function updateReadAloudButton(e){e&&(e.innerHTML=isReading?"ü§´":"üì¢",e.title=isReading?"Stop Reading":"Read Aloud")}function togglePlaylistView(){playlistView.classList.contains("hidden")?(displayPlaylist(),playlistView.classList.remove("hidden")):playlistView.classList.add("hidden")}function displayPlaylist(){if(playlistItemsContainer.innerHTML="",0===playlist.length)return playlistItemsContainer.innerHTML='<p class="text-center text-gray-500">Your playlist is empty.</p>',void(clearPlaylistBtn.disabled=!0);clearPlaylistBtn.disabled=!1,playlist.forEach((e,t)=>{const n=document.createElement("div");n.className="playlist-item flex items-center justify-between p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors";let o,r;"rhyme"===e.type?(o=allRhymes.find(t=>t.id===e.id),r=o?o.icon||"üéµ":"üéµ"):(o=allStories.find(t=>t.id===e.id),r=o?o.icon||"üìö":"üìö");if(!o)return;const a='<span class="text-2xl text-yellow-500">üîä</span>',i=`<span class="text-2xl">${r}</span>`;n.innerHTML=`\n                <div class="flex items-center gap-3 cursor-pointer flex-grow" data-item-id="${o.id}" data-item-type="${e.type}" data-action="play">\n                    ${isPlaylistMode&&t===currentPlaylistIndex?a:i}\n                    <span class="font-semibold text-brand-dark">${o.title}</span>\n                </div>\n                <button class="p-2 rounded-full hover:bg-red-100 text-red-500 button-pop" data-item-id="${o.id}" data-item-type="${e.type}" data-action="remove" aria-label="Remove ${o.title} from playlist" title="Remove from playlist">\n                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>\n                </button>\n            `,isPlaylistMode&&t===currentPlaylistIndex&&n.classList.add("playing"),playlistItemsContainer.appendChild(n)})}function updatePlaylistCount(){playlistCountEl.textContent=playlist.length,playlistCountEl.classList.toggle("hidden",0===playlist.length)}function isInPlaylist(e,t){return playlist.some(n=>n.id===e&&n.type===t)}function handleAddToPlaylist(e){if(!currentRhyme)return;triggerButtonAnimation(e.currentTarget);const t=currentRhyme.id,n=isInPlaylist(t,"rhyme");n?(playlist=playlist.filter(e=>!(e.id===t&&"rhyme"===e.type)),showToast("Removed from playlist")):(playlist.push({type:"rhyme",id:t}),showToast("Added to playlist!")),localStorage.setItem("playlist",JSON.stringify(playlist)),updatePlaylistCount(),updateAddToPlaylistButton()}function updateAddToPlaylistButton(){if(!currentRhyme)return;const e=isInPlaylist(currentRhyme.id,"rhyme");addToPlaylistBtn.innerHTML=e?'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>',addToPlaylistBtn.title=e?"Added to Playlist":"Add to Playlist"}function handleAddToStoryPlaylist(e){if(!currentStory)return;triggerButtonAnimation(e.currentTarget);const t=currentStory.id,n=isInPlaylist(t,"story");n?(playlist=playlist.filter(e=>!(e.id===t&&"story"===e.type)),showToast("Removed from playlist")):(playlist.push({type:"story",id:t}),showToast("Added to playlist!")),localStorage.setItem("playlist",JSON.stringify(playlist)),updatePlaylistCount(),updateAddToStoryPlaylistButton()}function updateAddToStoryPlaylistButton(){if(!currentStory)return;const e=isInPlaylist(currentStory.id,"story");addToStoryPlaylistBtn.innerHTML=e?'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>',addToStoryPlaylistBtn.title=e?"Added to Playlist":"Add to Playlist"}function clearPlaylist(){playlist=[],localStorage.setItem("playlist",JSON.stringify(playlist)),updatePlaylistCount(),displayPlaylist()}function handlePlaylistItemClick(e){const t=e.target.closest("[data-action]");if(!t)return;const n=parseInt(t.dataset.itemId),o=t.dataset.itemType,r=t.dataset.action;"play"===r?(togglePlaylistView(),(()=>{"rhyme"===o?showRhymeDetail(n,!0,playlist.findIndex(e=>e.id===n&&e.type===o)):showStoryDetail(n,!0,playlist.findIndex(e=>e.id===n&&e.type===o))})()):"remove"===r&&(playlist=playlist.filter(e=>!(e.id===n&&e.type===o)),localStorage.setItem("playlist",JSON.stringify(playlist)),updatePlaylistCount(),displayPlaylist(),currentRhyme&&currentRhyme.id===n&&"rhyme"===o&&updateAddToPlaylistButton(),currentStory&&currentStory.id===n&&"story"===o&&updateAddToStoryPlaylistButton())}function updatePlaylistNav(){playlistNavButtons.classList.add("hidden"),storyPlaylistNavButtons.classList.add("hidden");if(isPlaylistMode&&playlist.length>0&&-1!==currentPlaylistIndex){const e=playlist[currentPlaylistIndex];if(!e)return;let t,n,o,r;"rhyme"===e.type?(t=playlistNavButtons,n=playlistPositionEl,o=prevRhymeBtn,r=nextRhymeBtn):"story"===e.type&&(t=storyPlaylistNavButtons,n=storyPlaylistPositionEl,o=prevStoryBtn,r=nextStoryBtn),t&&(t.classList.remove("hidden"),n.textContent=`${currentPlaylistIndex+1} / ${playlist.length}`,o.disabled=currentPlaylistIndex<=0,r.disabled=currentPlaylistIndex>=playlist.length-1)}}function playNextPlaylistItem(){if(isPlaylistMode&&currentPlaylistIndex<playlist.length-1){const e=currentPlaylistIndex+1,t=playlist[e];"rhyme"===t.type?showRhymeDetail(t.id,!0,e):"story"===t.type&&showStoryDetail(t.id,!0,e)}}function playPreviousPlaylistItem(){if(isPlaylistMode&&currentPlaylistIndex>0){const e=currentPlaylistIndex-1,t=playlist[e];"rhyme"===t.type?showRhymeDetail(t.id,!0,e):"story"===t.type&&showStoryDetail(t.id,!0,e)}}function handleFavoriteClick(e){if(!currentRhyme)return;triggerButtonAnimation(e.currentTarget);const t=currentRhyme.id,n=favorites.indexOf(t);n>-1?favorites.splice(n,1):favorites.push(t),localStorage.setItem("favoriteRhymes",JSON.stringify(favorites)),e.currentTarget.innerHTML=isFavorite(t)?"‚ù§Ô∏è":"ü§ç";const o=rhymeGrid.querySelector(`.rhyme-card[data-rhyme-id="${t}"] .favorite-indicator`);o&&(o.textContent=isFavorite(t)?"‚ù§Ô∏è":"")}function isFavorite(e){return favorites.includes(e)}function handleFavoriteStoryClick(e){if(!currentStory)return;triggerButtonAnimation(e.currentTarget);const t=currentStory.id,n=favoriteStories.indexOf(t);n>-1?favoriteStories.splice(n,1):favoriteStories.push(t),localStorage.setItem("favoriteStories",JSON.stringify(favoriteStories)),e.currentTarget.innerHTML=isFavoriteStory(t)?"‚ù§Ô∏è":"ü§ç";const o=storyGrid.querySelector(`.story-card[data-story-id="${t}"] .favorite-indicator`);o&&(o.textContent=isFavoriteStory(t)?"‚ù§Ô∏è":"")}function isFavoriteStory(e){return favoriteStories.includes(e)}function handleScroll(){backToTopBtn.classList.toggle("show",window.scrollY>300)}function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}function triggerButtonAnimation(e){e.classList.add("animate-pop"),e.addEventListener("animationend",()=>{e.classList.remove("animate-pop")},{once:!0})}const footerYear=document.getElementById("footer-year");footerYear&&(footerYear.textContent=(new Date).getFullYear())});
