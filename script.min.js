document.addEventListener('DOMContentLoaded',()=>{let allRhymes=[],allStories=[],allExclusiveRhymes=[],authors={"Vikas Rana":{bio:"Vikas Rana is a passionate storyteller and creator based in the beautiful hills of Dharamshala. He loves crafting imaginative tales and catchy rhymes that spark curiosity and joy in young readers. He believes in the power of simple words to create magical worlds for children. When he's not writing, he enjoys exploring nature and sipping on a warm cup of chai.",image:"https://placehold.co/150x150/E34037/FFFFFF?text=VR",x_profile:"https://x.com/Vikasrana03"}},currentRhymeList=[],favorites=JSON.parse(localStorage.getItem('favoriteRhymes'))||[],favoriteStories=JSON.parse(localStorage.getItem('favoriteStories'))||[],playlist=JSON.parse(localStorage.getItem('playlist'))||[],currentRhyme=null,currentStory=null,isPlaylistMode=!1,currentPlaylistIndex=-1,originalTitle=document.title,utterance=null,isReading=!1,englishVoice=null,hindiVoice=null;const loadingIndicator=document.getElementById('loading-indicator'),homeButton=document.getElementById('home-button'),rhymeGalleryView=document.getElementById('rhyme-gallery'),storyGalleryView=document.getElementById('story-gallery'),rhymeDetailView=document.getElementById('rhyme-detail'),storyDetailView=document.getElementById('story-detail'),legalView=document.getElementById('legal-view'),comingSoonView=document.getElementById('coming-soon-view'),authorDetailView=document.getElementById('author-detail'),rhymeOfTheDaySection=document.getElementById('rhyme-of-the-day'),rhymeGrid=document.getElementById('rhyme-grid'),storyGrid=document.getElementById('story-grid'),comingSoonRhymesList=document.getElementById('coming-soon-rhymes-list'),comingSoonStoriesList=document.getElementById('coming-soon-stories-list'),authorStoriesGrid=document.getElementById('author-stories-grid'),controlsSection=document.getElementById('controls-section'),rhymeControls=document.getElementById('rhyme-controls'),storyControls=document.getElementById('story-controls'),searchBar=document.getElementById('search-bar'),storySearchBar=document.getElementById('story-search-bar'),categoryFilters=document.getElementById('category-filters'),storyCategoryFilters=document.getElementById('story-category-filters'),surpriseButton=document.getElementById('surprise-button'),storySurpriseButton=document.getElementById('story-surprise-button'),backToTopBtn=document.getElementById('back-to-top-btn'),backButton=document.getElementById('back-button'),favoriteBtn=document.getElementById('favorite-btn'),previousDetailRhymeBtn=document.getElementById('previous-detail-rhyme-btn'),nextDetailRhymeBtn=document.getElementById('next-detail-rhyme-btn'),readAloudRhymeBtn=document.getElementById('read-aloud-btn-rhyme'),shareRhymeBtn=document.getElementById('share-rhyme-btn'),printRhymeBtn=document.getElementById('print-rhyme-btn'),storyBackButton=document.getElementById('story-back-button'),storyFavoriteBtn=document.getElementById('story-favorite-btn'),addToStoryPlaylistBtn=document.getElementById('add-to-story-playlist-btn'),previousDetailStoryBtn=document.getElementById('previous-detail-story-btn'),nextDetailStoryBtn=document.getElementById('next-detail-story-btn'),readAloudStoryBtn=document.getElementById('read-aloud-btn-story'),shareStoryBtn=document.getElementById('share-story-btn'),printStoryBtn=document.getElementById('print-story-btn'),storyAuthorContainer=document.getElementById('story-author-container'),legalLink=document.getElementById('legal-link'),legalBackButton=document.getElementById('legal-back-button'),comingSoonLink=document.getElementById('coming-soon-link'),comingSoonBackButton=document.getElementById('coming-soon-back-button'),authorBackButton=document.getElementById('author-back-button'),playlistToggleBtn=document.getElementById('playlist-toggle-btn'),playlistView=document.getElementById('playlist-view'),closePlaylistBtn=document.getElementById('close-playlist-btn'),playlistItemsContainer=document.getElementById('playlist-items'),clearPlaylistBtn=document.getElementById('clear-playlist-btn'),playlistCountEl=document.getElementById('playlist-count'),addToPlaylistBtn=document.getElementById('add-to-playlist-btn'),playlistNavButtons=document.getElementById('playlist-nav-buttons'),prevRhymeBtn=document.getElementById('prev-rhyme-btn'),nextRhymeBtn=document.getElementById('next-rhyme-btn'),playlistPositionEl=document.getElementById('playlist-position'),storyPlaylistNavButtons=document.getElementById('story-playlist-nav-buttons'),prevStoryBtn=document.getElementById('prev-story-btn'),nextStoryBtn=document.getElementById('next-story-btn'),storyPlaylistPositionEl=document.getElementById('story-playlist-position'),toastNotification=document.getElementById('toast-notification'),footerShareLink=document.getElementById('footer-share-link'),footerAuthorLink=document.getElementById('footer-author-link');function init(){loadAllData(),addEventListeners(),updatePlaylistCount()}async function fetchWithRetry(url,retries=3,delay=500){for(let i=0;i<retries;i++)try{const response=await fetch(url);if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`);return await response.json()}catch(error){if(console.warn(`Attempt ${i+1} failed for ${url}. Retrying in ${delay}ms...`,error),i<retries-1)await new Promise(resolve=>setTimeout(resolve,delay)),delay*=2;else throw error}}async function loadAllData(){try{const[rhymesPublic,rhymesExclusive,stories]=await Promise.all([fetchWithRetry('public_rhymes.json'),fetchWithRetry('exclusive_rhymes.json'),fetchWithRetry('short_stories.json')]);allExclusiveRhymes=rhymesExclusive,allStories=stories;const currentDate=new Date,filteredExclusiveRhymes=allExclusiveRhymes.filter(rhyme=>!rhyme.releaseDate||new Date(rhyme.releaseDate)<=currentDate);allRhymes=[...rhymesPublic,...filteredExclusiveRhymes].sort((a,b)=>a.id-b.id),handleUrlParams(),loadingIndicator.style.display='none'}catch(error){console.error("Could not fetch data after multiple retries:",error),loadingIndicator.innerHTML='<p class="text-red-500 text-center font-body">Sorry, could not load content. Please check your internet connection and try refreshing the page.</p>'}}function handleUrlParams(){const urlParams=new URLSearchParams(window.location.search),rhymeId=urlParams.get('rhyme'),storyId=urlParams.get('story'),authorName=urlParams.get('author'),category=urlParams.get('category'),page=urlParams.get('page');rhymeId?showRhymeDetail(parseInt(rhymeId)):storyId?showStoryDetail(parseInt(storyId)):authorName?showAuthorDetail(authorName):'legal'===page?showLegalView():'coming-soon'===page?showComingSoonView():category?(updateActiveCategoryButton(category),showMainView(category)):showMainView('Rhymes')}function updateUrl(params){const url=new URL(window.location);url.search='';for(const key in params)params[key]&&url.searchParams.set(key,params[key]);window.history.pushState({},'',url),updateCanonicalUrl(url.href)}function updateCanonicalUrl(url){let link=document.querySelector("link[rel='canonical']");link&&link.setAttribute('href',url)}function updateJsonLd(item,type){const existingSchema=document.getElementById('item-schema');if(existingSchema&&existingSchema.remove(),!item)return;const schema={"@context":"https://schema.org",mainEntityOfPage:{"@type":"WebPage","@id":window.location.href},headline:item.title,publisher:{"@type":"Organization",name:"kids.toolblaster.com"}};'rhyme'===type?(schema["@type"]="CreativeWork",schema.text=item.lyrics,schema.author={"@type":"Person",name:"Traditional"},item.isExclusive?(schema.copyrightHolder={"@type":"Organization",name:"kids.toolblaster.com"},schema.copyrightYear=(new Date).getFullYear()):(schema.license="https://creativecommons.org/publicdomain/mark/1.0/",schema.citation="Based on a traditional public domain nursery rhyme.")):'story'===type?(schema["@type"]="ShortStory",schema.text=item.content.join("\n\n"),schema.author={"@type":"Person",name:item.author},schema.copyrightHolder={"@type":"Organization",name:"kids.toolblaster.com"},schema.copyrightYear=(new Date).getFullYear()):'author'===type&&(schema["@type"]="ProfilePage",schema.about={"@type":"Person",name:item.name,description:item.bio});const script=document.createElement('script');script.type='application/ld+json',script.id='item-schema',script.text=JSON.stringify(schema,null,2),document.head.appendChild(script)}function hideAllViews(){rhymeGalleryView.classList.add('hidden'),storyGalleryView.classList.add('hidden'),rhymeDetailView.classList.add('hidden'),storyDetailView.classList.add('hidden'),legalView.classList.add('hidden'),comingSoonView.classList.add('hidden'),authorDetailView.classList.add('hidden'),rhymeOfTheDaySection.classList.add('hidden'),controlsSection.classList.add('hidden'),rhymeControls.classList.add('hidden'),storyControls.classList.add('hidden'),stopReading()}function showMainView(viewName){hideAllViews(),controlsSection.classList.remove('hidden'),updateJsonLd(null);let storiesToDisplay,rhymesToDisplay;if('Stories'===viewName||'StoryFavorites'===viewName)storyGalleryView.classList.remove('hidden'),storyControls.classList.remove('hidden'),storiesToDisplay='StoryFavorites'===viewName?allStories.filter(s=>isFavoriteStory(s.id)):allStories.filter(story=>!story.releaseDate||new Date(story.releaseDate)<=new Date),displayStoryGallery(storiesToDisplay);else{rhymeGalleryView.classList.remove('hidden'),rhymeControls.classList.remove('hidden'),rhymeOfTheDaySection.classList.remove('hidden'),rhymesToDisplay='Favorites'===viewName?allRhymes.filter(r=>isFavorite(r.id)):'New'===viewName?allRhymes.filter(r=>r.isExclusive):'Lullaby'===viewName?allRhymes.filter(r=>r.tags&&r.tags.includes('lullaby')):['Animal','Learning','Classic','Indian'].includes(viewName)?allRhymes.filter(r=>r.category===viewName):allRhymes,displayRhymeGallery(rhymesToDisplay),displayRhymeOfTheDay()}}function showLegalView(){hideAllViews(),legalView.classList.remove('hidden'),document.title="Contact & Legal - Kids Rhymes & Stories",updateUrl({page:'legal'}),window.scrollTo(0,0)}function showComingSoonView(){hideAllViews(),comingSoonView.classList.remove('hidden'),document.title="Coming Soon! - Kids Rhymes & Stories",updateUrl({page:'coming-soon'}),window.scrollTo(0,0);const currentDate=new Date,upcomingRhymes=allExclusiveRhymes.filter(rhyme=>rhyme.releaseDate&&new Date(rhyme.releaseDate)>currentDate).sort((a,b)=>new Date(a.releaseDate)-new Date(b.releaseDate)),upcomingStories=allStories.filter(story=>story.releaseDate&&new Date(story.releaseDate)>currentDate).sort((a,b)=>new Date(a.releaseDate)-new Date(b.releaseDate));comingSoonRhymesList.innerHTML='',comingSoonStoriesList.innerHTML='';const createItemElement=(item,type)=>{const releaseDate=new Date(item.releaseDate),options={year:'numeric',month:'long',day:'numeric'},formattedDate=releaseDate.toLocaleDateString('en-US',options),itemEl=document.createElement('div'),borderColorClass='Story'===type?'border-blue-500':'border-green-500';return itemEl.className=`flex items-center p-4 bg-gray-50 rounded-lg shadow-sm border-l-4 ${borderColorClass}`,itemEl.innerHTML=`
                <div class="text-4xl mr-4">${item.icon||('Rhyme'==='Rhyme'?'🎵':'📚')}</div>
                <div class="flex-grow">
                    <h3 class="text-base font-bold text-brand-dark">${item.title}</h3>
                    <p class="text-sm text-gray-600 font-body">Coming on: <span class="font-semibold">${formattedDate}</span></p>
                </div>
            `,itemEl};upcomingRhymes.length>0?upcomingRhymes.forEach(rhyme=>{comingSoonRhymesList.appendChild(createItemElement(rhyme,'Rhyme'))}):comingSoonRhymesList.innerHTML='<p class="text-center text-gray-600 font-body p-4 bg-gray-50 rounded-lg">No new rhymes scheduled right now.</p>',upcomingStories.length>0?upcomingStories.forEach(story=>{comingSoonStoriesList.appendChild(createItemElement(story,'Story'))}):comingSoonStoriesList.innerHTML='<p class="text-center text-gray-600 font-body p-4 bg-gray-50 rounded-lg">No new stories scheduled right now.</p>'}function goHome(){searchBar.value='',storySearchBar.value='',isPlaylistMode=!1,currentPlaylistIndex=-1,updateActiveCategoryButton('Rhymes'),showMainView('Rhymes'),updateUrl({category:'Rhymes'}),document.title=originalTitle}function goBackToGallery(){document.title=originalTitle,isPlaylistMode=!1,currentPlaylistIndex=-1;const activeCategory=document.querySelector('.main-nav-btn.active').dataset.category||'Rhymes';showMainView(activeCategory),updateUrl({category:activeCategory})}function goBackToStoryGalleryFromAuthor(){document.title=originalTitle,showMainView('Stories'),updateUrl({category:'Stories'})}function displayRhymeGallery(rhymesToDisplay){currentRhymeList=rhymesToDisplay,rhymeGrid.innerHTML='';if(0===rhymesToDisplay.length){const activeButton=document.querySelector('#category-filters .category-btn.active');let emptyMessage='<p class="text-gray-500 col-span-full text-center font-body">No rhymes found for your search.</p>';return activeButton&&'Favorites'===activeButton.dataset.category&&(emptyMessage=`
                    <div class="col-span-full text-center p-6 bg-gray-50 rounded-lg">
                        <div class="text-4xl mb-2">❤️</div>
                        <h3 class="text-lg font-bold text-brand-dark">Your Favorites is Empty</h3>
                        <p class="text-gray-500 mt-1 font-body">Click the white heart on any rhyme to add it here!</p>
                    </div>
                `),void(rhymeGrid.innerHTML=emptyMessage)}rhymesToDisplay.forEach(rhyme=>{const card=document.createElement('div');card.className='rhyme-card bg-white rounded-xl shadow-lg cursor-pointer transform hover:scale-105 transition-all duration-300 flex flex-col p-4 text-center relative',card.dataset.rhymeId=rhyme.id;const isNew=rhyme.isExclusive,newBadge=isNew?'<div class="absolute top-1 left-1 bg-yellow-400 text-black text-xs font-bold px-2 py-0.5 rounded-full">NEW</div>':'',favoriteIndicator=isFavorite(rhyme.id)?'❤️':'';card.innerHTML=`
                ${newBadge}
                <div class="flex-grow flex flex-col items-center justify-center">
                    <div class="text-5xl mb-2">${rhyme.icon||'🎵'}</div>
                    <h3 class="text-sm font-bold text-brand-dark">${rhyme.title}</h3>
                </div>
                <div class="absolute top-2 right-2 text-xl favorite-indicator">${favoriteIndicator}</div>
            `,card.addEventListener('click',()=>showRhymeDetail(rhyme.id)),rhymeGrid.appendChild(card)})}function showRhymeDetail(rhymeId,fromPlaylist=!1,playlistIndex=-1){if(currentRhyme=allRhymes.find(r=>r.id===rhymeId),!currentRhyme)return;currentStory=null,hideAllViews(),rhymeDetailView.classList.remove('hidden'),document.title=`${currentRhyme.title} - Kids Rhymes`,updateUrl({rhyme:rhymeId}),updateJsonLd(currentRhyme,'rhyme'),stopReading(),updateReadAloudButton(readAloudRhymeBtn),isPlaylistMode=fromPlaylist,currentPlaylistIndex=fromPlaylist?playlistIndex:-1,document.getElementById('rhyme-title-en').textContent=currentRhyme.title,document.getElementById('rhyme-lyrics-en').textContent=currentRhyme.lyrics;const titleHiEl=document.getElementById('rhyme-title-hi'),hindiColumn=document.getElementById('hindi-column');currentRhyme.title_hi&&currentRhyme.lyrics_hi?(titleHiEl.textContent=currentRhyme.title_hi,document.getElementById('rhyme-lyrics-hi').textContent=currentRhyme.lyrics_hi,hindiColumn.classList.remove('hidden')):(titleHiEl.textContent='',document.getElementById('rhyme-lyrics-hi').textContent='',hindiColumn.classList.add('hidden'));const learningFocusContainer=document.getElementById('learning-focus-badge-container');currentRhyme.learningFocus?(document.getElementById('learning-focus-badge').textContent=`Focus: ${currentRhyme.learningFocus}`,learningFocusContainer.classList.remove('hidden')):learningFocusContainer.classList.add('hidden'),favoriteBtn.innerHTML=isFavorite(rhymeId)?'❤️':'🤍',favoriteBtn.setAttribute('data-id',rhymeId);const funFactContainer=document.getElementById('fun-fact-container'),funFactDetails=document.getElementById('fun-fact-details');currentRhyme.funFact?(document.getElementById('fun-fact-text').textContent=currentRhyme.funFact,funFactContainer.classList.remove('hidden'),funFactDetails.removeAttribute('open')):funFactContainer.classList.add('hidden');const copyrightContainer=document.getElementById('copyright-notice-container'),copyrightText=document.getElementById('copyright-text');copyrightContainer.classList.remove('hidden'),copyrightText.textContent=currentRhyme.isExclusive?`Copyright © ${(new Date).getFullYear()} kids.toolblaster.com. This is an Original and Exclusive Rhyme 🎵`:"This content is in the public domain.";const listToUse=currentRhymeList.find(r=>r.id===rhymeId)?currentRhymeList:allRhymes,currentIndex=listToUse.findIndex(r=>r.id===rhymeId);previousDetailRhymeBtn.disabled=currentIndex<=0,nextDetailRhymeBtn.disabled=currentIndex>=listToUse.length-1,updateAddToPlaylistButton(),updatePlaylistNav(),window.scrollTo(0,0)}function displayStoryGallery(storiesToDisplay){storyGrid.innerHTML='';if(0===storiesToDisplay.length){const activeButton=document.querySelector('#story-category-filters .category-btn.active');let emptyMessage='<p class="text-gray-500 col-span-full text-center font-body">No stories found for your search.</p>';return activeButton&&'StoryFavorites'===activeButton.dataset.category&&(emptyMessage=`
                    <div class="col-span-full text-center p-6 bg-gray-50 rounded-lg">
                        <div class="text-4xl mb-2">❤️</div>
                        <h3 class="text-lg font-bold text-brand-dark">Your Favorite Stories is Empty</h3>
                        <p class="text-gray-500 mt-1 font-body">Click the white heart on any story to add it here!</p>
                    </div>
                `),void(storyGrid.innerHTML=emptyMessage)}storiesToDisplay.forEach(story=>{const card=document.createElement('div');card.className='story-card bg-white rounded-xl shadow-lg cursor-pointer transform hover:scale-105 transition-all duration-300 flex flex-col p-4 text-center relative',card.dataset.storyId=story.id;const newBadge='<div class="absolute top-1 left-1 bg-yellow-400 text-black text-xs font-bold px-2 py-0.5 rounded-full">NEW</div>',favoriteIndicator=isFavoriteStory(story.id)?'❤️':'';card.innerHTML=`
                ${newBadge}
                <div class="flex-grow flex flex-col items-center justify-center">
                    <div class="text-5xl mb-2">${story.icon||'📚'}</div>
                    <h3 class="text-sm font-bold text-brand-dark">${story.title}</h3>
                    <p class="text-sm text-gray-500 mt-1 font-body">by ${story.author}</p>
                </div>
                <div class="absolute top-2 right-2 text-xl favorite-indicator">${favoriteIndicator}</div>
            `,card.addEventListener('click',()=>showStoryDetail(story.id)),storyGrid.appendChild(card)})}function showStoryDetail(storyId,fromPlaylist=!1,playlistIndex=-1){if(currentStory=allStories.find(s=>s.id===storyId),!currentStory)return;currentRhyme=null,hideAllViews(),storyDetailView.classList.remove('hidden'),document.title=`${currentStory.title} - Kids Stories`,updateUrl({story:storyId}),updateJsonLd(currentStory,'story'),stopReading(),updateReadAloudButton(readAloudStoryBtn),isPlaylistMode=fromPlaylist,currentPlaylistIndex=fromPlaylist?playlistIndex:-1,document.getElementById('story-title').textContent=currentStory.title;const storyAuthorLink=document.getElementById('story-author-link');storyAuthorLink.textContent=currentStory.author,storyAuthorLink.dataset.author=currentStory.author,document.getElementById('story-read-time').textContent=currentStory.readTime;const storyContentEl=document.getElementById('story-content');storyContentEl.innerHTML='',currentStory.content.forEach(paragraph=>{const p=document.createElement('p');p.textContent=paragraph.trim(),storyContentEl.appendChild(p)});const storyTitleHiEl=document.getElementById('story-title-hi'),storyContentHiContainer=document.getElementById('story-content-hi-container'),storyContentHiEl=document.getElementById('story-content-hi');if(currentStory.title_hi&&currentStory.content_hi)storyTitleHiEl.textContent=currentStory.title_hi,storyContentHiEl.innerHTML='',currentStory.content_hi.forEach(paragraph=>{const p=document.createElement('p');p.textContent=paragraph.trim(),storyContentHiEl.appendChild(p)}),storyContentHiContainer.classList.remove('hidden');else{storyTitleHiEl.textContent='',storyContentHiContainer.classList.add('hidden')}const moralContainer=document.getElementById('story-moral-container'),moralHiContainer=document.getElementById('story-moral-hi').parentElement;currentStory.moral?(document.getElementById('story-moral').textContent=currentStory.moral,currentStory.moral_hi?(document.getElementById('story-moral-hi').textContent=currentStory.moral_hi,moralHiContainer.classList.remove('hidden')):moralHiContainer.classList.add('hidden'),moralContainer.classList.remove('hidden')):moralContainer.classList.add('hidden');const storyCopyrightContainer=document.getElementById('story-copyright-notice-container'),storyCopyrightText=document.getElementById('story-copyright-text');storyCopyrightText.textContent=`Copyright © ${(new Date).getFullYear()} kids.toolblaster.com. This is an Original and Exclusive Story 📚`,storyCopyrightContainer.classList.remove('hidden');const availableStories=allStories.filter(story=>!story.releaseDate||new Date(story.releaseDate)<=new Date),currentIndex=availableStories.findIndex(s=>s.id===currentStory.id);previousDetailStoryBtn.disabled=currentIndex<=0,nextDetailStoryBtn.disabled=currentIndex>=availableStories.length-1,storyFavoriteBtn.innerHTML=isFavoriteStory(storyId)?'❤️':'🤍',updateAddToStoryPlaylistButton(),updatePlaylistNav(),window.scrollTo(0,0)}function showAuthorDetail(authorName){const authorData=authors[authorName];if(!authorData)return void goBackToStoryGalleryFromAuthor();hideAllViews(),authorDetailView.classList.remove('hidden'),document.title=`${authorName} - Author Profile`,updateUrl({author:authorName}),updateJsonLd({name:authorName,...authorData},'author'),document.getElementById('author-name').textContent=authorName,document.getElementById('author-bio').textContent=authorData.bio,document.getElementById('author-image').src=authorData.image,document.getElementById('author-image').alt=`A photo of ${authorName}`;const authorSocialLink=document.getElementById('author-social-link');authorData.x_profile?(authorSocialLink.href=authorData.x_profile,authorSocialLink.classList.remove('hidden')):authorSocialLink.classList.add('hidden'),window.scrollTo(0,0)}function displayRhymeOfTheDay(){const dayOfYear=Math.floor((new Date-new Date((new Date).getFullYear(),0,0))/864e5),rhyme=allRhymes[dayOfYear%allRhymes.length];rhyme&&(document.getElementById('rotd-icon').textContent=rhyme.icon||'🎵',document.getElementById('rotd-title').textContent=rhyme.title,document.getElementById('rotd-card').addEventListener('click',()=>showRhymeDetail(rhyme.id)))}function addEventListeners(){homeButton.addEventListener('click',goHome),backButton.addEventListener('click',goBackToGallery),storyBackButton.addEventListener('click',goBackToGallery),legalBackButton.addEventListener('click',goHome),authorBackButton.addEventListener('click',goBackToStoryGalleryFromAuthor),legalLink.addEventListener('click',e=>{e.preventDefault(),showLegalView()}),comingSoonLink.addEventListener('click',e=>{e.preventDefault(),showComingSoonView()}),comingSoonBackButton.addEventListener('click',goHome),searchBar.addEventListener('input',handleSearchInput),storySearchBar.addEventListener('input',handleStorySearchInput),document.getElementById('main-navigation').addEventListener('click',handleCategoryClick),categoryFilters.addEventListener('click',handleCategoryClick),storyCategoryFilters.addEventListener('click',handleCategoryClick),surpriseButton.addEventListener('click',showRandomRhyme),storySurpriseButton.addEventListener('click',showRandomStory),previousDetailRhymeBtn.addEventListener('click',showPreviousRhyme),nextDetailRhymeBtn.addEventListener('click',showNextRhyme),previousDetailStoryBtn.addEventListener('click',showPreviousStory),nextDetailStoryBtn.addEventListener('click',showNextStory),favoriteBtn.addEventListener('click',handleFavoriteClick),storyFavoriteBtn.addEventListener('click',handleFavoriteStoryClick),addToStoryPlaylistBtn.addEventListener('click',handleAddToStoryPlaylist),storyAuthorContainer.addEventListener('click',e=>{if('story-author-link'===e.target.id){e.preventDefault();const authorName=e.target.dataset.author;authorName&&showAuthorDetail(authorName)}}),readAloudRhymeBtn.addEventListener('click',()=>toggleReadAloud('rhyme')),readAloudStoryBtn.addEventListener('click',()=>toggleReadAloud('story')),playlistToggleBtn.addEventListener('click',togglePlaylistView),closePlaylistBtn.addEventListener('click',togglePlaylistView),addToPlaylistBtn.addEventListener('click',handleAddToPlaylist),clearPlaylistBtn.addEventListener('click',clearPlaylist),playlistItemsContainer.addEventListener('click',handlePlaylistItemClick),prevRhymeBtn.addEventListener('click',playPreviousPlaylistItem),nextRhymeBtn.addEventListener('click',playNextPlaylistItem),prevStoryBtn.addEventListener('click',playPreviousPlaylistItem),nextStoryBtn.addEventListener('click',playNextPlaylistItem),window.addEventListener('scroll',handleScroll),backToTopBtn.addEventListener('click',scrollToTop),shareRhymeBtn.addEventListener('click',()=>shareContent('rhyme')),printRhymeBtn.addEventListener('click',()=>printContent('rhyme')),shareStoryBtn.addEventListener('click',()=>shareContent('story')),printStoryBtn.addEventListener('click',()=>printContent('story')),footerShareLink.addEventListener('click',e=>{e.preventDefault(),shareContent('website')}),footerAuthorLink.addEventListener('click',e=>{e.preventDefault(),showAuthorDetail("Vikas Rana")})}function handleSearchInput(){let filtered=allRhymes.filter(rhyme=>rhyme.title.toLowerCase().includes(searchBar.value.toLowerCase())||rhyme.lyrics.toLowerCase().includes(searchBar.value.toLowerCase()));displayRhymeGallery(filtered)}function handleStorySearchInput(){let filtered=allStories.filter(story=>!story.releaseDate||new Date(story.releaseDate)<=new Date).filter(story=>story.title.toLowerCase().includes(storySearchBar.value.toLowerCase())||story.content.join(' ').toLowerCase().includes(storySearchBar.value.toLowerCase()));displayStoryGallery(filtered)}function handleCategoryClick(e){const clickedButton=e.target.closest('.category-btn');clickedButton&&(searchBar.value='',storySearchBar.value='');const category=clickedButton.dataset.category;updateActiveCategoryButton(category),showMainView(category),updateUrl({category:category})}function updateActiveCategoryButton(categoryToActivate){document.querySelectorAll('#category-filters .category-btn, #story-category-filters .category-btn').forEach(btn=>{btn.classList.remove('active')});const activeButton=document.querySelector(`.category-btn[data-category="${categoryToActivate}"]`);activeButton&&!activeButton.closest('#main-navigation')&&activeButton.classList.add('active');const isStoryFilter=['Stories','StoryFavorites'].includes(categoryToActivate);document.querySelector('.main-nav-btn[data-category="Stories"]').classList.toggle('active',isStoryFilter),document.querySelector('.main-nav-btn[data-category="Rhymes"]').classList.toggle('active',!isStoryFilter)}function showRandomRhyme(){const randomIndex=Math.floor(Math.random()*allRhymes.length);showRhymeDetail(allRhymes[randomIndex].id)}function showRandomStory(){const availableStories=allStories.filter(story=>!story.releaseDate||new Date(story.releaseDate)<=new Date),randomIndex=Math.floor(Math.random()*availableStories.length);showStoryDetail(availableStories[randomIndex].id)}function showPreviousRhyme(){if(!currentRhyme)return;const listToUse=currentRhymeList.find(r=>r.id===currentRhyme.id)?currentRhymeList:allRhymes,currentIndex=listToUse.findIndex(r=>r.id===currentRhyme.id);currentIndex>0&&showRhymeDetail(listToUse[currentIndex-1].id)}function showNextRhyme(){if(!currentRhyme)return;const listToUse=currentRhymeList.find(r=>r.id===currentRhyme.id)?currentRhymeList:allRhymes,currentIndex=listToUse.findIndex(r=>r.id===currentRhyme.id);currentIndex<listToUse.length-1&&showRhymeDetail(listToUse[currentIndex+1].id)}function showPreviousStory(){if(!currentStory)return;const availableStories=allStories.filter(story=>!story.releaseDate||new Date(story.releaseDate)<=new Date),currentIndex=availableStories.findIndex(s=>s.id===currentStory.id);currentIndex>0&&showStoryDetail(availableStories[currentIndex-1].id)}function showNextStory(){if(!currentStory)return;const availableStories=allStories.filter(story=>!story.releaseDate||new Date(story.releaseDate)<=new Date),currentIndex=availableStories.findIndex(s=>s.id===currentStory.id);currentIndex<availableStories.length-1&&showStoryDetail(availableStories[currentIndex+1].id)}function showToast(message){toastNotification.textContent=message,toastNotification.classList.add('show'),setTimeout(()=>{toastNotification.classList.remove('show')},2500)}function shareContent(type){let url=window.location.href,title=document.title,text="Check out this fun website for kids!";'rhyme'===type&&currentRhyme?(title=`${currentRhyme.title} - Kids Rhymes & Stories`,text=`Check out the rhyme "${currentRhyme.title}"!`):'story'===type&&currentStory?(title=`${currentStory.title} - Kids Rhymes & Stories`,text=`Check out the story "${currentStory.title}"!`):url='https://kids.toolblaster.com/',navigator.share?navigator.share({title:title,text:text,url:url}).catch(console.error):navigator.clipboard.writeText(url).then(()=>{showToast('Link copied to clipboard!')},()=>{showToast('Could not copy link.')})}function printContent(type){document.body.classList.add('rhyme'===type?'printing-rhyme':'printing-story'),window.print(),document.body.classList.remove('printing-rhyme','printing-story')}function getVoiceForLanguage(lang){const allVoices=window.speechSynthesis.getVoices();let preferredVoice=null,fallbackVoice=null;const voicePriorities={'en-US':['Google US English Female','Microsoft Zira - English (United States)','Google UK English Female','Samantha'],'hi-IN':['Google हिन्दी']};return voicePriorities[lang]&&(preferredVoice=allVoices.find(voice=>voicePriorities[lang].includes(voice.name))),preferredVoice||(fallbackVoice=allVoices.find(voice=>voice.lang.startsWith(lang)&&(voice.name.includes('Female')||voice.name.includes('Google')))),!preferredVoice&&!fallbackVoice&&(fallbackVoice=allVoices.find(voice=>voice.lang.startsWith(lang))),preferredVoice||fallbackVoice||null}window.speechSynthesis.onvoiceschanged=()=>{englishVoice=getVoiceForLanguage('en-US'),hindiVoice=getVoiceForLanguage('hi-IN')};function toggleReadAloud(contentType){if(!('speechSynthesis'in window))return void showToast("Sorry, your browser doesn't support text-to-speech.");if(isReading)return void stopReading();let content,btn,hasHindi;if('rhyme'===contentType&&currentRhyme)content={en:currentRhyme.lyrics,hi:currentRhyme.lyrics_hi},btn=readAloudRhymeBtn,hasHindi=!!currentRhyme.lyrics_hi;else{if(!('story'===contentType&&currentStory))return;content={en:currentStory.content.join(' '),hi:currentStory.content_hi?currentStory.content_hi.join(' '):''},btn=readAloudStoryBtn,hasHindi=!!currentStory.content_hi}const utteranceEn=new SpeechSynthesisUtterance(content.en);if(utteranceEn.lang='en-US',englishVoice&&(utteranceEn.voice=englishVoice),utteranceEn.onstart=()=>{isReading=!0,updateReadAloudButton(btn)},hasHindi&&content.hi){const utteranceHi=new SpeechSynthesisUtterance(content.hi);utteranceHi.lang='hi-IN',hindiVoice&&(utteranceHi.voice=hindiVoice),utteranceEn.onend=()=>{isReading&&window.speechSynthesis.speak(utteranceHi)},utteranceHi.onend=()=>stopReading(btn)}else utteranceEn.onend=()=>stopReading(btn);window.speechSynthesis.speak(utteranceEn)}function stopReading(btnToUpdate){isReading=!1,window.speechSynthesis.cancel(),btnToUpdate?updateReadAloudButton(btnToUpdate):(updateReadAloudButton(readAloudRhymeBtn),updateReadAloudButton(readAloudStoryBtn))}function updateReadAloudButton(btn){btn&&(btn.innerHTML=isReading?'🤫':'📢',btn.title=isReading?'Stop Reading':'Read Aloud')}function togglePlaylistView(){playlistView.classList.contains('hidden')?(displayPlaylist(),playlistView.classList.remove('hidden')):playlistView.classList.add('hidden')}function displayPlaylist(){playlistItemsContainer.innerHTML='';if(0===playlist.length)return playlistItemsContainer.innerHTML='<p class="text-center text-gray-500">Your playlist is empty.</p>',void(clearPlaylistBtn.disabled=!0);clearPlaylistBtn.disabled=!1,playlist.forEach((item,index)=>{const itemEl=document.createElement('div');itemEl.className='playlist-item flex items-center justify-between p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors';let details,icon;'rhyme'===item.type?(details=allRhymes.find(r=>r.id===item.id),icon=details?details.icon||'🎵':'🎵'):(details=allStories.find(s=>s.id===item.id),icon=details?details.icon||'📚':'📚');if(!details)return;const playingIcon='<span class="text-2xl text-yellow-500">🔊</span>',defaultIcon=`<span class="text-2xl">${icon}</span>`;itemEl.innerHTML=`
                <div class="flex items-center gap-3 cursor-pointer flex-grow" data-item-id="${details.id}" data-item-type="${item.type}" data-action="play">
                    ${isPlaylistMode&&index===currentPlaylistIndex?playingIcon:defaultIcon}
                    <span class="font-semibold text-brand-dark">${details.title}</span>
                </div>
                <button class="p-2 rounded-full hover:bg-red-100 text-red-500 button-pop" data-item-id="${details.id}" data-item-type="${item.type}" data-action="remove" aria-label="Remove ${details.title} from playlist" title="Remove from playlist">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                </button>
            `,isPlaylistMode&&index===currentPlaylistIndex&&itemEl.classList.add('playing'),playlistItemsContainer.appendChild(itemEl)})}function updatePlaylistCount(){playlistCountEl.textContent=playlist.length,playlistCountEl.classList.toggle('hidden',0===playlist.length)}function isInPlaylist(id,type){return playlist.some(item=>item.id===id&&item.type===type)}function handleAddToPlaylist(e){if(!currentRhyme)return;triggerButtonAnimation(e.currentTarget);const rhymeId=currentRhyme.id,inPlaylist=isInPlaylist(rhymeId,'rhyme');inPlaylist?(playlist=playlist.filter(item=>!(item.id===rhymeId&&'rhyme'===item.type)),showToast('Removed from playlist')):(playlist.push({type:'rhyme',id:rhymeId}),showToast('Added to playlist!')),localStorage.setItem('playlist',JSON.stringify(playlist)),updatePlaylistCount(),updateAddToPlaylistButton()}function updateAddToPlaylistButton(){if(!currentRhyme)return;const inPlaylist=isInPlaylist(currentRhyme.id,'rhyme');addToPlaylistBtn.innerHTML=inPlaylist?'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>',addToPlaylistBtn.title=inPlaylist?"Added to Playlist":"Add to Playlist"}function handleAddToStoryPlaylist(e){if(!currentStory)return;triggerButtonAnimation(e.currentTarget);const storyId=currentStory.id,inPlaylist=isInPlaylist(storyId,'story');inPlaylist?(playlist=playlist.filter(item=>!(item.id===storyId&&'story'===item.type)),showToast('Removed from playlist')):(playlist.push({type:'story',id:storyId}),showToast('Added to playlist!')),localStorage.setItem('playlist',JSON.stringify(playlist)),updatePlaylistCount(),updateAddToStoryPlaylistButton()}function updateAddToStoryPlaylistButton(){if(!currentStory)return;const inPlaylist=isInPlaylist(currentStory.id,'story');addToStoryPlaylistBtn.innerHTML=inPlaylist?'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>',addToStoryPlaylistBtn.title=inPlaylist?"Added to Playlist":"Add to Playlist"}function clearPlaylist(){playlist=[],localStorage.setItem('playlist',JSON.stringify(playlist)),updatePlaylistCount(),displayPlaylist()}function handlePlaylistItemClick(e){const target=e.target.closest('[data-action]');if(!target)return;const itemId=parseInt(target.dataset.itemId),itemType=target.dataset.itemType,action=target.dataset.action;if('play'===action){togglePlaylistView();const playlistIndex=playlist.findIndex(item=>item.id===itemId&&item.type===itemType);'rhyme'===itemType?showRhymeDetail(itemId,!0,playlistIndex):showStoryDetail(itemId,!0,playlistIndex)}else'remove'===action&&(playlist=playlist.filter(item=>!(item.id===itemId&&item.type===itemType)),localStorage.setItem('playlist',JSON.stringify(playlist)),updatePlaylistCount(),displayPlaylist(),currentRhyme&&currentRhyme.id===itemId&&'rhyme'===itemType&&updateAddToPlaylistButton(),currentStory&&currentStory.id===itemId&&'story'===itemType&&updateAddToStoryPlaylistButton())}function updatePlaylistNav(){playlistNavButtons.classList.add('hidden'),storyPlaylistNavButtons.classList.add('hidden');if(isPlaylistMode&&playlist.length>0&&-1!==currentPlaylistIndex){const currentItem=playlist[currentPlaylistIndex];if(!currentItem)return;let navContainer,positionEl,prevBtn,nextBtn;'rhyme'===currentItem.type?(navContainer=playlistNavButtons,positionEl=playlistPositionEl,prevBtn=prevRhymeBtn,nextBtn=nextRhymeBtn):'story'===currentItem.type&&(navContainer=storyPlaylistNavButtons,positionEl=storyPlaylistPositionEl,prevBtn=prevStoryBtn,nextBtn=nextStoryBtn),navContainer&&(navContainer.classList.remove('hidden'),positionEl.textContent=`${currentPlaylistIndex+1} / ${playlist.length}`,prevBtn.disabled=currentPlaylistIndex<=0,nextBtn.disabled=currentPlaylistIndex>=playlist.length-1)}}function playNextPlaylistItem(){if(isPlaylistMode&&currentPlaylistIndex<playlist.length-1){const nextIndex=currentPlaylistIndex+1,nextItem=playlist[nextIndex];'rhyme'===nextItem.type?showRhymeDetail(nextItem.id,!0,nextIndex):'story'===nextItem.type&&showStoryDetail(nextItem.id,!0,nextIndex)}}function playPreviousPlaylistItem(){if(isPlaylistMode&&currentPlaylistIndex>0){const prevIndex=currentPlaylistIndex-1,prevItem=playlist[prevIndex];'rhyme'===prevItem.type?showRhymeDetail(prevItem.id,!0,prevIndex):'story'===prevItem.type&&showStoryDetail(prevItem.id,!0,prevIndex)}}function handleFavoriteClick(e){if(!currentRhyme)return;triggerButtonAnimation(e.currentTarget);const rhymeId=currentRhyme.id,favoriteIndex=favorites.indexOf(rhymeId);favoriteIndex>-1?favorites.splice(favoriteIndex,1):favorites.push(rhymeId),localStorage.setItem('favoriteRhymes',JSON.stringify(favorites)),e.currentTarget.innerHTML=isFavorite(rhymeId)?'❤️':'🤍';const rhymeCardIndicator=rhymeGrid.querySelector(`.rhyme-card[data-rhyme-id="${rhymeId}"] .favorite-indicator`);rhymeCardIndicator&&(rhymeCardIndicator.textContent=isFavorite(rhymeId)?'❤️':'')}function isFavorite(rhymeId){return favorites.includes(rhymeId)}function handleFavoriteStoryClick(e){if(!currentStory)return;triggerButtonAnimation(e.currentTarget);const storyId=currentStory.id,favoriteIndex=favoriteStories.indexOf(storyId);favoriteIndex>-1?favoriteStories.splice(favoriteIndex,1):favoriteStories.push(storyId),localStorage.setItem('favoriteStories',JSON.stringify(favoriteStories)),e.currentTarget.innerHTML=isFavoriteStory(storyId)?'❤️':'🤍';const storyCardIndicator=storyGrid.querySelector(`.story-card[data-story-id="${storyId}"] .favorite-indicator`);storyCardIndicator&&(storyCardIndicator.textContent=isFavoriteStory(storyId)?'❤️':'')}function isFavoriteStory(storyId){return favoriteStories.includes(storyId)}function handleScroll(){backToTopBtn.classList.toggle('show',window.scrollY>300)}function scrollToTop(){window.scrollTo({top:0,behavior:'smooth'})}function triggerButtonAnimation(btn){btn.classList.add('animate-pop'),btn.addEventListener('animationend',()=>{btn.classList.remove('animate-pop')},{once:!0})}init();const footerYear=document.getElementById('footer-year');footerYear&&(footerYear.textContent=(new Date).getFullYear())});
